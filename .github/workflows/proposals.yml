name: Proposal Validation

on:
  pull_request:
    paths:
      - 'proposals/**'
  push:
    branches: [main]
    paths:
      - 'proposals/**'

jobs:
  validate-proposals:
    name: Validate Proposals
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.10.6"
      
      - name: Checkout skill-validation-framework
        uses: actions/checkout@v4
        with:
          repository: hiveminderbot/skill-validation-framework
          path: skill-validation-framework
      
      - name: Install skill-validation-framework
        run: |
          cd skill-validation-framework
          uv sync --extra dev
          echo "$PWD/src" >> $GITHUB_PATH
      
      - name: Find changed proposals
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PR: compare against base branch
            git fetch origin ${{ github.base_ref }} --depth=1
            BASE="origin/${{ github.base_ref }}"
            CHANGED=$(git diff --name-only "$BASE...HEAD" | grep '^proposals/' | grep -v '^proposals/_template' | grep -v '^proposals/README.md' | grep -v '^proposals/CONVENTIONS.md' | cut -d'/' -f2 | sort -u | jq -R . | jq -s .)
          else
            # For push: check files in the last commit
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^proposals/' | grep -v '^proposals/_template' | grep -v '^proposals/README.md' | grep -v '^proposals/CONVENTIONS.md' | cut -d'/' -f2 | sort -u | jq -R . | jq -s .)
          fi
          
          # Handle empty result
          if [ "$CHANGED" = "[]" ] || [ -z "$CHANGED" ]; then
            CHANGED="[]"
            echo "No proposal changes detected"
          fi
          
          echo "proposals=$CHANGED" >> $GITHUB_OUTPUT
          echo "Changed proposals: $CHANGED"
      
      - name: Validate proposal structure
        run: |
          CHANGED='${{ steps.changed.outputs.proposals }}'
          
          if [ "$CHANGED" = "[]" ]; then
            echo "No proposals to validate"
            exit 0
          fi
          
          echo "$CHANGED" | jq -r '.[]' | while read proposal; do
            echo "Validating: $proposal"
            
            PROPOSAL_DIR="proposals/$proposal"
            
            if [ ! -d "$PROPOSAL_DIR" ]; then
              echo "❌ Proposal directory not found: $PROPOSAL_DIR"
              exit 1
            fi
            
            # Check required files exist
            for file in README.md install.sh test.sh; do
              if [ ! -f "$PROPOSAL_DIR/$file" ]; then
                echo "❌ Missing required file: $PROPOSAL_DIR/$file"
                exit 1
              fi
            done
            
            # Check scripts are executable
            for script in install.sh test.sh; do
              if [ ! -x "$PROPOSAL_DIR/$script" ]; then
                echo "❌ Script not executable: $PROPOSAL_DIR/$script"
                exit 1
              fi
            done
            
            # Validate README has required sections
            for section in "Summary" "Motivation" "Changes" "Testing" "Skill Validation Report"; do
              if ! grep -q "$section" "$PROPOSAL_DIR/README.md"; then
                echo "❌ README missing section: $section"
                exit 1
              fi
            done
            
            echo "✅ $proposal structure valid"
          done
      
      - name: Run proposal tests (dry-run)
        run: |
          CHANGED='${{ steps.changed.outputs.proposals }}'
          
          if [ "$CHANGED" = "[]" ]; then
            echo "No proposals to test"
            exit 0
          fi
          
          echo "$CHANGED" | jq -r '.[]' | while read proposal; do
            echo ""
            echo "Testing: $proposal"
            echo "================================"
            
            PROPOSAL_DIR="proposals/$proposal"
            
            # Run install script (in dry-run mode if supported)
            echo "Running install.sh..."
            if head -20 "$PROPOSAL_DIR/install.sh" | grep -q "dry-run\|--dry-run"; then
              cd "$PROPOSAL_DIR" && ./install.sh --dry-run || echo "⚠️  Install dry-run failed"
            else
              echo "ℹ️  Install script doesn't support dry-run, skipping"
            fi
            
            # Run test script (in validation mode)
            echo ""
            echo "Running test.sh..."
            cd "$PROPOSAL_DIR" && ./test.sh || echo "⚠️  Tests failed (expected in CI without full env)"
            
            cd "$GITHUB_WORKSPACE"
          done
      
      - name: Generate validation summary
        run: |
          CHANGED='${{ steps.changed.outputs.proposals }}'
          
          echo "## Proposal Validation Report" > validation-summary.md
          echo "" >> validation-summary.md
          echo "| Proposal | Structure | Validation Report |" >> validation-summary.md
          echo "|----------|-----------|-------------------|" >> validation-summary.md
          
          if [ "$CHANGED" != "[]" ]; then
            echo "$CHANGED" | jq -r '.[]' | while read proposal; do
              # Check if validation report section exists
              if grep -q "Skill Validation Report" "proposals/$proposal/README.md"; then
                VALIDATION="✅ Present"
              else
                VALIDATION="❌ Missing"
              fi
              
              echo "| $proposal | ✅ Valid | $VALIDATION |" >> validation-summary.md
            done
          else
            echo "| (none) | - | - |" >> validation-summary.md
          fi
          
          cat validation-summary.md
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('validation-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
